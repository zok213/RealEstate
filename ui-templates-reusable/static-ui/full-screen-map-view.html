<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Full Screen Map View - DXF Parser System</title>
    <!-- Critical CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
    <!-- Defer non-critical resources -->
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
    <!-- Critical scripts -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <!-- Defer utility scripts -->
    <script src="/static/js/api.js" defer></script>
    <script src="/static/js/utils.js" defer></script>
    <script src="/static/js/estate-nav.js" defer></script>
    <script src="/static/js/estate-map.js" defer></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#36e27b",
                        "background-light": "#f6f8f7",
                        "background-dark": "#112117",
                        "surface-dark": "#1b3224",
                        "surface-border": "#254632",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "2rem",
                        "xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar for panels */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #254632;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #36e27b;
        }
        .mapboxgl-popup-content {
            background-color: #1b3224 !important;
            color: white !important;
            border-radius: 1rem !important;
            border: 1px solid #254632 !important;
        }
        .mapboxgl-popup-close-button {
            background-color: #36e27b !important;
            color: #112117 !important;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: #112117;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #254632;
            border-top-color: #36e27b;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-dark font-display overflow-hidden h-screen w-screen flex flex-col relative text-white">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="text-white text-lg font-medium">Loading Map View...</p>
    </div>
    <!-- Top Navigation Bar (Floating) -->
    <header class="absolute top-4 left-4 right-4 z-50 flex items-center justify-between pointer-events-none">
        <!-- Left: Back & Title -->
        <div class="pointer-events-auto bg-surface-dark/80 backdrop-blur-md rounded-full px-2 pr-6 py-2 shadow-lg border border-surface-border flex items-center gap-4">
            <button onclick="window.location.href='/'" class="flex items-center justify-center size-10 rounded-full bg-surface-border hover:bg-primary hover:text-background-dark text-white transition-colors cursor-pointer" title="Back to Dashboard">
                <span class="material-symbols-outlined">home</span>
            </button>
            <div class="flex flex-col">
                <h1 class="text-sm font-medium text-gray-400 leading-none mb-1">Map View</h1>
                <h2 class="text-base font-bold text-white leading-none estate-title">Loading...</h2>
            </div>
        </div>
        <!-- Right: Actions -->
        <div class="pointer-events-auto flex items-center gap-3">
            <button id="toggle-chatbot-btn" class="bg-primary/20 hover:bg-primary text-white hover:text-background-dark font-bold text-sm px-5 h-12 rounded-full shadow-lg flex items-center gap-2 transition-colors border border-primary">
                <span class="material-symbols-outlined text-[20px]">smart_toy</span>
                AI Assistant
            </button>
            <button id="start-subdivision" class="bg-primary hover:bg-primary/90 text-background-dark font-bold text-sm px-5 h-12 rounded-full shadow-lg flex items-center gap-2 transition-colors">
                <span class="material-symbols-outlined text-[20px]">auto_awesome</span>
                Generate Plots
            </button>
            <div class="bg-surface-dark/80 backdrop-blur-md rounded-full p-1 pl-4 shadow-lg border border-surface-border flex items-center h-12">
                <input id="search-input" class="bg-transparent border-none focus:ring-0 text-white placeholder-gray-400 text-sm w-48" placeholder="Search plots..." type="text" />
                <button class="flex items-center justify-center size-10 rounded-full bg-surface-border text-white hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">search</span>
                </button>
            </div>
            <button class="bg-surface-dark/80 backdrop-blur-md hover:bg-surface-border text-white px-4 h-12 rounded-full shadow-lg border border-surface-border flex items-center gap-2 transition-colors">
                <span class="material-symbols-outlined text-[20px]">ios_share</span>
                Export
            </button>
            <button class="bg-surface-dark/80 backdrop-blur-md hover:bg-surface-border text-white size-12 rounded-full shadow-lg border border-surface-border flex items-center justify-center transition-colors">
                <span class="material-symbols-outlined">account_circle</span>
            </button>
        </div>
    </header>

    <!-- Map Container -->
    <div id="map" class="absolute inset-0 z-0 w-full h-full"></div>

    <!-- Left Panel: Legend -->
    <aside class="absolute top-24 left-4 bottom-8 w-64 z-40 flex flex-col gap-4 pointer-events-none">
        <!-- Collapsible Legend Panel -->
        <div class="pointer-events-auto bg-surface-dark/90 backdrop-blur-md border border-surface-border rounded-2xl p-5 shadow-xl flex flex-col max-h-[calc(100%-80px)]">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">layers</span>
                    Legend
                </h3>
                <button id="hide-all" class="text-xs text-primary hover:text-white transition-colors font-medium">Hide All</button>
            </div>
            <div class="overflow-y-auto pr-1 flex-1 flex flex-col gap-6">
                <!-- Layer Group: Zone Types (NEW) -->
                <div class="space-y-3" id="zone-legend">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Zone Types</h4>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 group">
                            <div class="size-3 rounded-sm bg-[#E53935]"></div>
                            <span class="text-sm text-gray-200">Factory (Top)</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <div class="size-3 rounded-sm bg-[#FB8C00]"></div>
                            <span class="text-sm text-gray-200">Warehouse (Middle)</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <div class="size-3 rounded-sm bg-[#FDD835]"></div>
                            <span class="text-sm text-gray-200">Residential (Bottom)</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <div class="size-3 rounded-sm bg-[#78909C]"></div>
                            <span class="text-sm text-gray-200">Service</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <div class="size-3 rounded-sm bg-[#43A047]"></div>
                            <span class="text-sm text-gray-200">Green / Parks</span>
                        </div>
                        <div class="flex items-center gap-3 group">
                            <div class="size-3 rounded-sm bg-[#1E88E5]"></div>
                            <span class="text-sm text-gray-200">Water Features</span>
                        </div>
                    </div>
                </div>
                <!-- Layer Group: Plots -->
                <div class="space-y-3">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Plots Status</h4>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input id="available-layer" checked="" class="form-checkbox rounded text-primary focus:ring-primary focus:ring-offset-0 bg-surface-border border-transparent size-4" type="checkbox" />
                            <div class="size-3 rounded-sm bg-green-500/20 border border-green-500"></div>
                            <span class="text-sm text-gray-200 group-hover:text-white">Available Plot</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input id="sold-layer" checked="" class="form-checkbox rounded text-primary focus:ring-primary focus:ring-offset-0 bg-surface-border border-transparent size-4" type="checkbox" />
                            <div class="size-3 rounded-sm bg-red-500/20 border border-red-500"></div>
                            <span class="text-sm text-gray-200 group-hover:text-white">Sold Plot</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input id="reserved-layer" class="form-checkbox rounded text-primary focus:ring-primary focus:ring-offset-0 bg-surface-border border-transparent size-4" type="checkbox" />
                            <div class="size-3 rounded-sm bg-yellow-500/20 border border-yellow-500"></div>
                            <span class="text-sm text-gray-200 group-hover:text-white">Reserved</span>
                        </label>
                    </div>
                </div>
                <!-- Layer Group: Infrastructure -->
                <div class="space-y-3">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Infrastructure</h4>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input id="roads-layer" checked="" class="form-checkbox rounded text-primary focus:ring-primary focus:ring-offset-0 bg-surface-border border-transparent size-4" type="checkbox" />
                            <div class="w-8 h-1 bg-gray-500 rounded-full"></div>
                            <span class="text-sm text-gray-200 group-hover:text-white">Roads</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input id="water-layer" class="form-checkbox rounded text-primary focus:ring-primary focus:ring-offset-0 bg-surface-border border-transparent size-4" type="checkbox" />
                            <div class="w-8 h-0.5 border-t-2 border-dashed border-blue-400"></div>
                            <span class="text-sm text-gray-200 group-hover:text-white">Water Lines</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input id="fire-layer" class="form-checkbox rounded text-primary focus:ring-primary focus:ring-offset-0 bg-surface-border border-transparent size-4" type="checkbox" />
                            <div class="size-3 rounded-full bg-red-500"></div>
                            <span class="text-sm text-gray-200 group-hover:text-white">Fire Station</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <!-- Zoom Controls -->
        <div class="pointer-events-auto flex flex-col gap-1 self-start">
            <button id="zoom-in" class="flex size-10 items-center justify-center rounded-t-xl rounded-b-md bg-surface-dark/90 backdrop-blur-md border border-surface-border text-white hover:bg-surface-border transition-colors shadow-lg">
                <span class="material-symbols-outlined">add</span>
            </button>
            <button id="zoom-out" class="flex size-10 items-center justify-center rounded-b-xl rounded-t-md bg-surface-dark/90 backdrop-blur-md border border-surface-border text-white hover:bg-surface-border transition-colors shadow-lg">
                <span class="material-symbols-outlined">remove</span>
            </button>
        </div>
        <button id="my-location" class="pointer-events-auto flex size-10 items-center justify-center rounded-xl bg-surface-dark/90 backdrop-blur-md border border-surface-border text-white hover:bg-surface-border transition-colors shadow-lg self-start">
            <span class="material-symbols-outlined">my_location</span>
        </button>
    </aside>

    <!-- Right Panel: AI Assistant (Chatbot) - Hidden by default for faster initial load -->
    <aside class="absolute top-24 right-4 bottom-8 w-96 z-40 pointer-events-none flex flex-col items-end">
        <!-- Chatbot Panel -->
        <div id="chatbot-panel" class="hidden pointer-events-auto bg-surface-dark/90 backdrop-blur-md border border-surface-border rounded-2xl shadow-xl flex flex-col w-full h-full">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-surface-border">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">smart_toy</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-white">AI Planning Assistant</h3>
                        <p class="text-xs text-gray-400">Intelligent layout recommendations</p>
                    </div>
                </div>
                <button id="toggle-chatbot" class="size-8 rounded-lg bg-surface-border hover:bg-primary hover:text-background-dark text-white transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-[20px]">close</span>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Messages will be added dynamically when chatbot opens -->
            </div>

            <!-- Quick Actions (Pre-defined Prompts) -->
            <div class="p-4 border-t border-surface-border space-y-2">
                <p class="text-xs font-semibold text-gray-400 mb-3">QUICK ACTIONS</p>
                <div class="grid grid-cols-2 gap-2" id="quick-actions">
                    <button class="quick-action-btn bg-surface-border hover:bg-primary/20 hover:border-primary text-white text-xs p-3 rounded-lg border border-transparent transition-all text-left" data-prompt="Ph√¢n t√≠ch k·∫øt qu·∫£ t·ªëi ∆∞u">
                        <span class="material-symbols-outlined text-[16px] text-primary mb-1">analytics</span>
                        <br/>Ph√¢n t√≠ch k·∫øt qu·∫£
                    </button>
                    <button class="quick-action-btn bg-surface-border hover:bg-primary/20 hover:border-primary text-white text-xs p-3 rounded-lg border border-transparent transition-all text-left" data-prompt="TƒÉng m·∫≠t ƒë·ªô b√£i ƒë·ªó xe">
                        <span class="material-symbols-outlined text-[16px] text-primary mb-1">local_parking</span>
                        <br/>TƒÉng parking
                    </button>
                    <button class="quick-action-btn bg-surface-border hover:bg-primary/20 hover:border-primary text-white text-xs p-3 rounded-lg border border-transparent transition-all text-left" data-prompt="C√¢n b·∫±ng t·ª∑ l·ªá zone">
                        <span class="material-symbols-outlined text-[16px] text-primary mb-1">balance</span>
                        <br/>C√¢n b·∫±ng zones
                    </button>
                    <button class="quick-action-btn bg-surface-border hover:bg-primary/20 hover:border-primary text-white text-xs p-3 rounded-lg border border-transparent transition-all text-left" data-prompt="T·ªëi ∆∞u green buffer">
                        <span class="material-symbols-outlined text-[16px] text-primary mb-1">park</span>
                        <br/>T·ªëi ∆∞u c√¢y xanh
                    </button>
                    <button class="quick-action-btn bg-surface-border hover:bg-primary/20 hover:border-primary text-white text-xs p-3 rounded-lg border border-transparent transition-all text-left" data-prompt="ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc lot">
                        <span class="material-symbols-outlined text-[16px] text-primary mb-1">resize</span>
                        <br/>ƒêi·ªÅu ch·ªânh lots
                    </button>
                    <button class="quick-action-btn bg-surface-border hover:bg-primary/20 hover:border-primary text-white text-xs p-3 rounded-lg border border-transparent transition-all text-left" data-prompt="Th√™m water features">
                        <span class="material-symbols-outlined text-[16px] text-primary mb-1">water_drop</span>
                        <br/>Th√™m h·ªì n∆∞·ªõc
                    </button>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t border-surface-border">
                <div class="flex gap-2">
                    <input 
                        id="chat-input" 
                        type="text" 
                        placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c y√™u c·∫ßu..." 
                        class="flex-1 bg-surface-border border-none rounded-xl px-4 py-3 text-white text-sm placeholder-gray-400 focus:ring-2 focus:ring-primary"
                    />
                    <button id="send-chat" class="size-11 rounded-xl bg-primary hover:bg-primary/90 text-background-dark flex items-center justify-center transition-colors">
                        <span class="material-symbols-outlined">send</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Filters Panel (Collapsed by default) -->
        <div id="filters-panel" class="hidden pointer-events-auto bg-surface-dark/90 backdrop-blur-md border border-surface-border rounded-2xl p-5 shadow-xl flex flex-col h-auto max-h-full">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">tune</span>
                    Filters
                </h3>
            </div>
            <div class="overflow-y-auto pr-1 flex-1 space-y-8">
                <!-- Filter Group: Status -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex justify-between">
                        Plot Status
                        <span class="text-[10px] bg-surface-border px-1.5 py-0.5 rounded text-white">3 Active</span>
                    </h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between cursor-pointer p-3 rounded-xl bg-surface-border/30 hover:bg-surface-border/60 transition-colors border border-transparent hover:border-primary/30">
                            <div class="flex items-center gap-3">
                                <input id="available-filter" checked="" class="form-checkbox rounded-full text-primary focus:ring-0 bg-background-dark border-gray-600 size-5" type="checkbox" />
                                <span class="text-sm font-medium text-white">Available</span>
                            </div>
                            <span class="text-xs font-bold text-primary bg-primary/10 px-2 py-1 rounded-full">12</span>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer p-3 rounded-xl bg-surface-border/30 hover:bg-surface-border/60 transition-colors border border-transparent hover:border-primary/30">
                            <div class="flex items-center gap-3">
                                <input id="sold-filter" class="form-checkbox rounded-full text-gray-500 focus:ring-0 bg-background-dark border-gray-600 size-5" type="checkbox" />
                                <span class="text-sm font-medium text-gray-300">Sold</span>
                            </div>
                            <span class="text-xs font-bold text-gray-400 bg-black/20 px-2 py-1 rounded-full">45</span>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer p-3 rounded-xl bg-surface-border/30 hover:bg-surface-border/60 transition-colors border border-transparent hover:border-primary/30">
                            <div class="flex items-center gap-3">
                                <input id="reserved-filter" class="form-checkbox rounded-full text-gray-500 focus:ring-0 bg-background-dark border-gray-600 size-5" type="checkbox" />
                                <span class="text-sm font-medium text-gray-300">Reserved</span>
                            </div>
                            <span class="text-xs font-bold text-gray-400 bg-black/20 px-2 py-1 rounded-full">5</span>
                        </label>
                    </div>
                </div>
                <!-- Filter Group: Area Range -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Area Range (m¬≤)</h4>
                    <div class="px-2">
                        <input type="range" id="area-slider" min="1000" max="10000" value="5000" class="w-full h-2 bg-surface-border rounded-lg appearance-none cursor-pointer slider" />
                        <div class="flex justify-between text-xs text-gray-400 font-medium mt-2">
                            <span id="area-min">1,000</span>
                            <span id="area-max">10,000+</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-surface-border flex gap-3">
                <button id="reset-filters" class="flex-1 py-2.5 rounded-full text-sm font-bold text-white bg-surface-border hover:bg-white/10 transition-colors">Reset</button>
                <button id="apply-filters" class="flex-1 py-2.5 rounded-full text-sm font-bold text-background-dark bg-primary hover:bg-primary/90 transition-colors shadow-[0_0_15px_rgba(54,226,123,0.3)]">Apply</button>
            </div>
        </div>
    </aside>

    <!-- Scale Indicator (Bottom Right) -->
    <div class="absolute bottom-4 right-4 z-30 pointer-events-none">
        <div class="bg-surface-dark/90 backdrop-blur-md border border-surface-border rounded-full px-3 py-1 flex items-center gap-2 text-[10px] text-gray-400 shadow-lg">
            <span>500 m</span>
            <div class="w-16 h-1.5 border-b-2 border-l-2 border-r-2 border-gray-500"></div>
        </div>
    </div>

    <!-- Map initialized by estate-map.js -->
    <script>
        // Placeholder for filters - can be enhanced later
        function resetFilters() {
            console.log('Reset filters');
        }

        function applyFilters() {
            console.log('Apply filters');
        }

        function initMapOld() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 10.762622, lng: 106.660172 },
                zoom: 18,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#112117" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#112117" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
                    {
                        featureType: "administrative.locality",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#36e27b" }],
                    },
                    {
                        featureType: "poi",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#36e27b" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "geometry",
                        stylers: [{ color: "#1b3224" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#36e27b" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#254632" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#254632" }],
                    },
                    {
                        featureType: "road",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#36e27b" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry",
                        stylers: [{ color: "#254632" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#254632" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#36e27b" }],
                    },
                    {
                        featureType: "transit",
                        elementType: "geometry",
                        stylers: [{ color: "#254632" }],
                    },
                    {
                        featureType: "transit.station",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#36e27b" }],
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#1b3224" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#36e27b" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.stroke",
                        stylers: [{ color: "#112117" }],
                    },
                ],
                disableDefaultUI: true,
                zoomControl: false,
            });

            infoWindow = new google.maps.InfoWindow();

            // Add markers for plots
            plots.forEach(plot => {
                const marker = new google.maps.Marker({
                    position: { lat: plot.lat, lng: plot.lng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: getStatusColor(plot.status),
                        fillOpacity: 0.8,
                        strokeWeight: 2,
                        strokeColor: '#ffffff',
                    },
                    title: plot.id,
                });

                marker.addListener('click', () => {
                    infoWindow.setContent(`
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-lg font-bold text-white">${plot.id}</h3>
                                    <p class="text-xs text-gray-400">Industrial Zone</p>
                                </div>
                                <span class="px-2 py-0.5 rounded-full bg-primary/20 text-primary text-[10px] font-bold uppercase tracking-wide border border-primary/30">${plot.status}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <div class="bg-surface-border/50 p-2 rounded-lg">
                                    <p class="text-[10px] text-gray-400 uppercase">Area</p>
                                    <p class="text-sm font-medium text-white">${plot.size.toLocaleString()} m¬≤</p>
                                </div>
                                <div class="bg-surface-border/50 p-2 rounded-lg">
                                    <p class="text-[10px] text-gray-400 uppercase">Price</p>
                                    <p class="text-sm font-medium text-white">$${plot.price.toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="flex-1 bg-primary text-background-dark text-xs font-bold py-2 rounded-full hover:bg-primary/90 transition-colors">View Details</button>
                                <button class="size-8 flex items-center justify-center rounded-full bg-surface-border text-white hover:bg-white/10 transition-colors">
                                    <span class="material-symbols-outlined text-[18px]">edit</span>
                                </button>
                            </div>
                        </div>
                    `);
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });

            // Event listeners for controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                map.setZoom(map.getZoom() + 1);
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                map.setZoom(map.getZoom() - 1);
            });

            document.getElementById('my-location').addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        map.setCenter(pos);
                    });
                }
            });

            // Layer toggles
            document.getElementById('available-layer').addEventListener('change', toggleLayers);
            document.getElementById('sold-layer').addEventListener('change', toggleLayers);
            document.getElementById('reserved-layer').addEventListener('change', toggleLayers);

            // Filter controls
            document.getElementById('area-slider').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                document.getElementById('area-min').textContent = value.toLocaleString();
                filterPlots();
            });

            document.getElementById('available-filter').addEventListener('change', filterPlots);
            document.getElementById('sold-filter').addEventListener('change', filterPlots);
            document.getElementById('reserved-filter').addEventListener('change', filterPlots);

            document.getElementById('reset-filters').addEventListener('click', resetFilters);
            document.getElementById('apply-filters').addEventListener('click', applyFilters);

            document.getElementById('hide-all').addEventListener('click', () => {
                document.querySelectorAll('#available-layer, #sold-layer, #reserved-layer').forEach(cb => cb.checked = false);
                toggleLayers();
            });

            // Search functionality
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                markers.forEach((marker, index) => {
                    const plot = plots[index];
                    const visible = plot.id.toLowerCase().includes(query);
                    marker.setVisible(visible);
                });
            });
        }

        function getStatusColor(status) {
            switch (status) {
                case 'available': return '#10b981'; // green
                case 'sold': return '#ef4444'; // red
                case 'reserved': return '#f59e0b'; // yellow
                default: return '#6b7280'; // gray
            }
        }

        function toggleLayers() {
            const availableVisible = document.getElementById('available-layer').checked;
            const soldVisible = document.getElementById('sold-layer').checked;
            const reservedVisible = document.getElementById('reserved-layer').checked;

            markers.forEach((marker, index) => {
                const plot = plots[index];
                let visible = false;
                if (plot.status === 'available' && availableVisible) visible = true;
                if (plot.status === 'sold' && soldVisible) visible = true;
                if (plot.status === 'reserved' && reservedVisible) visible = true;
                marker.setVisible(visible);
            });
        }

        function filterPlots() {
            const minArea = parseInt(document.getElementById('area-slider').value);
            const availableChecked = document.getElementById('available-filter').checked;
            const soldChecked = document.getElementById('sold-filter').checked;
            const reservedChecked = document.getElementById('reserved-filter').checked;

            markers.forEach((marker, index) => {
                const plot = plots[index];
                const sizeMatch = plot.size >= minArea;
                const statusMatch = (plot.status === 'available' && availableChecked) ||
                                   (plot.status === 'sold' && soldChecked) ||
                                   (plot.status === 'reserved' && reservedChecked);
                marker.setVisible(sizeMatch && statusMatch);
            });
        }

        function resetFilters() {
            document.getElementById('area-slider').value = 1000;
            document.getElementById('area-min').textContent = '1,000';
            document.getElementById('available-filter').checked = true;
            document.getElementById('sold-filter').checked = false;
            document.getElementById('reserved-filter').checked = false;
            filterPlots();
        }

        function applyFilters() {
            filterPlots();
        }

        // ======================================
        // CHATBOT FUNCTIONALITY
        // ======================================
        let chatbotOpen = false; // Start closed for faster load
        let currentOptimizationResult = null;
        let chatbotInitialized = false;

        function toggleChatbot() {
            const panel = document.getElementById('chatbot-panel');
            const btn = document.getElementById('toggle-chatbot-btn');
            
            chatbotOpen = !chatbotOpen;
            
            if (chatbotOpen) {
                panel.classList.remove('hidden');
                btn.classList.add('bg-primary', 'text-background-dark');
                btn.classList.remove('bg-primary/20', 'text-white');
                
                // Initialize chatbot content on first open (lazy load)
                if (!chatbotInitialized) {
                    initializeChatbot();
                    chatbotInitialized = true;
                }
            } else {
                panel.classList.add('hidden');
                btn.classList.remove('bg-primary', 'text-background-dark');
                btn.classList.add('bg-primary/20', 'text-white');
            }
        }

        function initializeChatbot() {
            // Add welcome message only when opened
            const welcomeMsg = `Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI quy ho·∫°ch. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:\n\n` +
                `‚Ä¢ Ph√¢n t√≠ch k·∫øt qu·∫£ t·ªëi ∆∞u hi·ªán t·∫°i\n` +
                `‚Ä¢ ƒêi·ªÅu ch·ªânh th√¥ng s·ªë quy ho·∫°ch\n` +
                `‚Ä¢ ƒê·ªÅ xu·∫•t c·∫£i ti·∫øn layout`;
            
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages && chatMessages.children.length === 0) {
                // Only add if empty
                setTimeout(() => {
                    addMessageToChat(welcomeMsg);
                }, 300);
            }
        }

        function addMessageToChat(message, isUser = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3' + (isUser ? ' justify-end' : '');
            
            if (!isUser) {
                messageDiv.innerHTML = `
                    <div class="size-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-primary text-[18px]">smart_toy</span>
                    </div>
                    <div class="bg-surface-border rounded-2xl rounded-tl-sm p-4 max-w-[85%]">
                        <p class="text-sm text-white leading-relaxed">${message}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-primary/20 border border-primary rounded-2xl rounded-tr-sm p-4 max-w-[85%]">
                        <p class="text-sm text-white leading-relaxed">${message}</p>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function generateChatbotResponse(userMessage) {
            // Analyze current optimization result if available
            if (!currentOptimizationResult) {
                return "‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ t·ªëi ∆∞u. Vui l√≤ng click 'Generate Plots' tr∆∞·ªõc.";
            }

            const stats = currentOptimizationResult.statistics || {};
            const lots = currentOptimizationResult.lots || [];
            const amenities = currentOptimizationResult.amenities || {};

            // Generate context-aware responses
            if (userMessage.includes('ph√¢n t√≠ch') || userMessage.includes('k·∫øt qu·∫£')) {
                const totalLots = stats.total_lots || lots.length;
                const totalParks = amenities.parks?.length || 0;
                const totalWater = amenities.lakes?.length || 0;
                const totalParking = amenities.parking?.length || 0;

                return `üìä **Ph√¢n t√≠ch k·∫øt qu·∫£ t·ªëi ∆∞u:**\n\n` +
                    `‚úÖ **T·ªïng s·ªë l√¥:** ${totalLots} l√¥\n` +
                    `üå≥ **Khu c√¢y xanh:** ${totalParks} khu (${stats.total_parks_area || 0}m¬≤)\n` +
                    `üíß **M·∫∑t n∆∞·ªõc:** ${totalWater} h·ªì\n` +
                    `üÖøÔ∏è **B√£i ƒë·ªó xe:** ${totalParking} khu\n\n` +
                    `üìà **ƒê√°nh gi√°:** Layout hi·ªán t·∫°i tu√¢n th·ªß QCVN 01:2021/BXD v·ªõi t·ª∑ l·ªá c√¢y xanh ƒë·∫°t ti√™u chu·∫©n.`;
            }

            if (userMessage.includes('parking') || userMessage.includes('ƒë·ªó xe')) {
                const parkingCount = amenities.parking?.length || 0;
                return `üÖøÔ∏è **B√£i ƒë·ªó xe hi·ªán t·∫°i:**\n\n` +
                    `C√≥ ${parkingCount} khu parking ƒë∆∞·ª£c ph√¢n b·ªï.\n\n` +
                    `üí° **ƒê·ªÅ xu·∫•t:** M·ªói block n√™n c√≥ 1 lot nh·ªè l√†m b√£i ƒë·ªó xe (15% di·ªán t√≠ch lot).`;
            }

            if (userMessage.includes('zone') || userMessage.includes('c√¢n b·∫±ng')) {
                return `‚öñÔ∏è **Ph√¢n b·ªï zone hi·ªán t·∫°i:**\n\n` +
                    `üî¥ FACTORY: 40% (S·∫£n xu·∫•t)\n` +
                    `üü† WAREHOUSE: 30% (Kho b√£i)\n` +
                    `üîµ SERVICE: 25% (D·ªãch v·ª•)\n` +
                    `üü¢ GREEN: 5% (C√¢y xanh)\n\n` +
                    `‚úÖ T·ª∑ l·ªá n√†y tu√¢n th·ªß QCVN 01:2021/BXD.`;
            }

            if (userMessage.includes('green') || userMessage.includes('c√¢y xanh') || userMessage.includes('buffer')) {
                const totalParks = amenities.parks?.length || 0;
                return `üå≥ **Green Buffer System:**\n\n` +
                    `‚úÖ Perimeter buffer: 30m\n` +
                    `‚úÖ Zone separation: 20m\n` +
                    `‚úÖ T·ªïng ${totalParks} khu c√¢y xanh\n\n` +
                    `üí° **ƒê·ªÅ xu·∫•t:** Th√™m tree pattern ƒë·ªÉ tƒÉng t√≠nh th·∫©m m·ªπ.`;
            }

            if (userMessage.includes('lot') || userMessage.includes('k√≠ch th∆∞·ªõc')) {
                const avgWidth = stats.avg_lot_width || 80;
                return `üìê **Th√¥ng s·ªë lot:**\n\n` +
                    `üìè Chi·ªÅu r·ªông TB: ${avgWidth.toFixed(1)}m\n` +
                    `üì¶ Target: 80m (QCVN)\n` +
                    `üìä Range: 40m - 150m\n\n` +
                    `‚úÖ Lots ƒëang trong kho·∫£ng ti√™u chu·∫©n.`;
            }

            if (userMessage.includes('water') || userMessage.includes('h·ªì')) {
                const totalWater = amenities.lakes?.length || 0;
                return `üíß **Water Features:**\n\n` +
                    `C√≥ ${totalWater} h·ªì n∆∞·ªõc ƒë∆∞·ª£c t·∫°o.\n\n` +
                    `üí° **L·ª£i √≠ch:**\n` +
                    `- ƒêi·ªÅu h√≤a kh√¥ng kh√≠\n` +
                    `- TƒÉng c·∫£nh quan\n` +
                    `- Tho√°t n∆∞·ªõc m∆∞a`;
            }

            // Default response
            return `T√¥i c√≥ th·ªÉ gi√∫p b·∫°n ph√¢n t√≠ch v√† t·ªëi ∆∞u layout. H√£y th·ª≠ c√°c c√¢u h·ªèi:\n\n` +
                `‚Ä¢ "Ph√¢n t√≠ch k·∫øt qu·∫£ t·ªëi ∆∞u"\n` +
                `‚Ä¢ "TƒÉng m·∫≠t ƒë·ªô b√£i ƒë·ªó xe"\n` +
                `‚Ä¢ "C√¢n b·∫±ng t·ª∑ l·ªá zone"\n` +
                `‚Ä¢ "T·ªëi ∆∞u green buffer"`;
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessageToChat(message, true);
            input.value = '';
            
            // Simulate AI thinking
            setTimeout(() => {
                const response = generateChatbotResponse(message);
                addMessageToChat(response);
            }, 500);
        }

        // Event listeners for chatbot
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading overlay when page ready
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }, 500);

            const toggleBtn = document.getElementById('toggle-chatbot-btn');
            const closeBtn = document.getElementById('toggle-chatbot');
            const sendBtn = document.getElementById('send-chat');
            const chatInput = document.getElementById('chat-input');
            const quickActions = document.querySelectorAll('.quick-action-btn');

            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleChatbot);
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', toggleChatbot);
            }

            if (sendBtn) {
                sendBtn.addEventListener('click', sendChatMessage);
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }

            // Quick action buttons (lazy attach - only when chatbot opens)
            if (quickActions.length > 0) {
                quickActions.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.getAttribute('data-prompt');
                        const input = document.getElementById('chat-input');
                        if (input) {
                            input.value = prompt;
                            sendChatMessage();
                        }
                    });
                });
            }
        });
    </script>

    <!-- Subdivision Configuration Modal -->
    <div id="subdivision-modal" class="hidden fixed inset-0 z-[9999] bg-black/60 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-surface-dark border border-surface-border rounded-2xl p-8 shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary text-3xl">tune</span>
                    Plot Subdivision Configuration
                </h2>
                <button id="close-modal" class="size-10 rounded-full bg-surface-border hover:bg-primary hover:text-background-dark text-white transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="subdivision-form" class="space-y-6">
                <!-- Grid Spacing -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Grid Spacing (meters)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-400">Minimum</label>
                            <input type="number" id="spacing-min" value="80" min="10" max="200" class="w-full bg-surface-border border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Maximum</label>
                            <input type="number" id="spacing-max" value="100" min="10" max="200" class="w-full bg-surface-border border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                    </div>
                </div>

                <!-- Lot Width -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Lot Width (meters)</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs text-gray-400">Minimum</label>
                            <input type="number" id="lot-width-min" value="40" min="10" max="100" class="w-full bg-surface-border border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Target</label>
                            <input type="number" id="lot-width-target" value="80" min="20" max="100" class="w-full bg-surface-border border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Maximum</label>
                            <input type="number" id="lot-width-max" value="150" min="40" max="200" class="w-full bg-surface-border border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                    </div>
                </div>

                <!-- Infrastructure -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Infrastructure</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-400">Road Width (m)</label>
                            <input type="number" id="road-width" value="10" min="3" max="30" class="w-full bg-surface-border border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Block Depth (m)</label>
                            <input type="number" id="block-depth" value="80" min="30" max="200" class="w-full bg-surface-border border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                    </div>
                </div>

                <!-- Advanced Options -->
                <details class="bg-surface-border rounded-xl p-4">
                    <summary class="cursor-pointer text-sm font-semibold text-gray-300 uppercase tracking-wide flex items-center justify-between">
                        <span>Advanced Options</span>
                        <span class="material-symbols-outlined text-primary">expand_more</span>
                    </summary>
                    <div class="mt-4 space-y-3">
                        <div>
                            <label class="text-xs text-gray-400">Population Size</label>
                            <input type="number" id="population-size" value="10" min="10" max="200" class="w-full bg-background-dark border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Generations</label>
                            <input type="number" id="generations" value="15" min="10" max="500" class="w-full bg-background-dark border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Solver Time Limit (seconds)</label>
                            <input type="number" id="time-limit" value="10" min="0.1" max="60" step="0.1" class="w-full bg-background-dark border-none rounded-lg px-4 py-3 text-white mt-1" />
                        </div>
                    </div>
                </details>

                <!-- Processing Status -->
                <div id="processing-status" class="hidden bg-primary/10 border border-primary/30 rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="animate-spin">
                            <span class="material-symbols-outlined text-primary">progress_activity</span>
                        </div>
                        <div>
                            <div class="text-sm font-semibold text-white">Processing Subdivision...</div>
                            <div class="text-xs text-gray-400 mt-1" id="processing-message">Initializing...</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center gap-3 pt-4">
                    <button type="button" id="cancel-subdivision" class="flex-1 bg-surface-border hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="run-subdivision" class="flex-1 bg-primary hover:bg-primary/90 text-background-dark font-bold py-3 px-6 rounded-xl transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">rocket_launch</span>
                        Start Processing
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Subdivision modal control
        const modal = document.getElementById('subdivision-modal');
        const startButton = document.getElementById('start-subdivision');
        const closeButton = document.getElementById('close-modal');
        const cancelButton = document.getElementById('cancel-subdivision');
        const form = document.getElementById('subdivision-form');
        const processingStatus = document.getElementById('processing-status');
        const processingMessage = document.getElementById('processing-message');

        startButton.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        function closeModal() {
            modal.classList.add('hidden');
            processingStatus.classList.add('hidden');
            // Force remove any overlay/backdrop elements
            document.body.style.overflow = 'auto';
        }

        closeButton.addEventListener('click', closeModal);
        cancelButton.addEventListener('click', closeModal);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get session ID from URL
            const sessionId = window.location.pathname.split('/').pop();
            
            // Show processing status
            processingStatus.classList.remove('hidden');
            document.getElementById('run-subdivision').disabled = true;
            
            try {
                // Fetch session data to get boundary
                processingMessage.textContent = 'Loading boundary data...';
                const sessionResponse = await fetch(`/api/session/${sessionId}`);
                const sessionData = await sessionResponse.json();
                
                // Get boundary coordinates - prefer GeoJSON with real coordinates
                let boundaryCoords = null;
                
                if (sessionData.metadata?.geojson?.features) {
                    const boundaryFeature = sessionData.metadata.geojson.features.find(f => 
                        f.properties?.type === 'boundary' || f.id === 'boundary');
                    if (boundaryFeature && boundaryFeature.geometry.coordinates) {
                        boundaryCoords = boundaryFeature.geometry.coordinates;
                        console.log('[SUBDIVISION] Using GeoJSON boundary (geographic coordinates)');
                        console.log('[SUBDIVISION] Boundary coords count:', boundaryFeature.geometry.coordinates[0]?.length);
                    }
                }
                
                if (!boundaryCoords && sessionData.boundary?.coordinates) {
                    boundaryCoords = sessionData.boundary.coordinates;
                    console.log('[SUBDIVISION] Using session boundary (may be metric coordinates)');
                }
                
                if (!boundaryCoords) {
                    throw new Error('No boundary data found in session');
                }
                
                // Prepare request payload
                const config = {
                    spacing_min: parseFloat(document.getElementById('spacing-min').value),
                    spacing_max: parseFloat(document.getElementById('spacing-max').value),
                    min_lot_width: parseFloat(document.getElementById('lot-width-min').value),
                    target_lot_width: parseFloat(document.getElementById('lot-width-target').value),
                    max_lot_width: parseFloat(document.getElementById('lot-width-max').value),
                    road_width: parseFloat(document.getElementById('road-width').value),
                    block_depth: parseFloat(document.getElementById('block-depth').value),
                    population_size: parseInt(document.getElementById('population-size').value),
                    generations: parseInt(document.getElementById('generations').value),
                    ortools_time_limit: parseFloat(document.getElementById('time-limit').value)
                };
                
                const landPlot = {
                    type: 'Polygon',
                    coordinates: boundaryCoords,
                    properties: sessionData.metadata || {}
                };
                
                const requestBody = {
                    config: config,
                    land_plots: [landPlot]
                };
                
                console.log('[SUBDIVISION] Request:', requestBody);
                processingMessage.textContent = 'Running optimization algorithm...';
                
                // Call optimization API
                const response = await fetch('/api/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Optimization failed');
                }
                
                const result = await response.json();
                console.log('[SUBDIVISION] Result:', result);
                
                processingMessage.textContent = 'Rendering plots on map...';
                
                // Store result in window for parent page to access
                window.subdivisionResult = result;
                console.log(`[SUBDIVISION] Stored ${result.total_lots} lots in window.subdivisionResult`);
                
                // Render results immediately on map (wait for map to be ready)
                setTimeout(() => {
                    if (window.map && window.map.loaded()) {
                        renderSubdivisionResults(result);
                    } else {
                        console.warn('[RENDER] Map not ready, waiting...');
                        window.addEventListener('mapReady', () => {
                            renderSubdivisionResults(result);
                        });
                    }
                }, 500);
                
                // Close modal after success
                setTimeout(() => {
                    closeModal();
                    document.getElementById('run-subdivision').disabled = false;
                    
                    // Trigger custom event for parent page to render
                    window.dispatchEvent(new CustomEvent('subdivisionComplete', { 
                        detail: result 
                    }));
                    
                    // Success notification with zone breakdown
                    const zones = {};
                    result.stages.forEach(stage => {
                        if (stage.geometry?.features) {
                            stage.geometry.features.forEach(f => {
                                if (f.properties?.zone) {
                                    zones[f.properties.zone] = (zones[f.properties.zone] || 0) + 1;
                                }
                            });
                        }
                    });
                    
                    const zoneBreakdown = Object.entries(zones)
                        .map(([zone, count]) => `${zone}: ${count}`)
                        .join(', ');
                    
                    alert(`Plot subdivision completed successfully!\n\n` +
                          `Total: ${result.total_lots} lots\n` +
                          `Zones: ${zoneBreakdown}`);
                }, 1000);
                
            } catch (error) {
                console.error('[SUBDIVISION] Error:', error);
                alert(`Subdivision failed: ${error.message}`);
                processingStatus.classList.add('hidden');
                document.getElementById('run-subdivision').disabled = false;
            }
        });

        function renderSubdivisionResults(result) {
            console.log('[RENDER] Starting to render subdivision results');
            
            // Get map from global scope (initialized by estate-map.js)
            const map = window.map;
            
            if (!map) {
                console.error('[RENDER] Map not available!');
                return;
            }
            
            // Remove existing subdivision layers if any
            const layersToRemove = [
                'subdivision-lots',
                'subdivision-lots-outline',
                'subdivision-parks',
                'subdivision-amenities'
            ];
            layersToRemove.forEach(layerId => {
                if (map.getLayer(layerId)) map.removeLayer(layerId);
            });
            
            if (map.getSource('subdivision-results')) {
                map.removeSource('subdivision-results');
            }
            
            // Extract ALL features (lots, parks, amenities) from all stages
            const allFeatures = [];
            let lotCount = 0;
            
            result.stages.forEach(stage => {
                if (stage.geometry && stage.geometry.features) {
                    stage.geometry.features.forEach(feature => {
                        // Include lots and amenity features
                        const type = feature.properties?.type;
                        if (type === 'lot' || feature.properties?.zone) {
                            allFeatures.push(feature);
                            lotCount++;
                            
                            // Log zone distribution
                            if (lotCount <= 10) {
                                console.log(`[RENDER] Feature ${lotCount}: zone=${feature.properties.zone}`);
                            }
                        }
                    });
                }
            });
            
            console.log(`[RENDER] Found ${allFeatures.length} features to render`);
            
            if (allFeatures.length === 0) {
                console.warn('[RENDER] No features to render');
                return;
            }
            
            // Add all features as GeoJSON source
            map.addSource('subdivision-results', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: allFeatures
                }
            });
            
            // Add fill layer with ZONE-BASED COLORS matching reference design
            map.addLayer({
                id: 'subdivision-lots',
                type: 'fill',
                source: 'subdivision-results',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'zone'],
                        'FACTORY', '#E53935',      // Red - Large factories (top)
                        'WAREHOUSE', '#FB8C00',    // Orange - Storage (middle)  
                        'RESIDENTIAL', '#FDD835',  // Yellow - Housing (bottom)
                        'SERVICE', '#78909C',      // Blue-gray - Utilities
                        'GREEN', '#43A047',        // Green - Parks, buffers
                        'WATER', '#1E88E5',        // Blue - Lakes, water features
                        '#BDBDBD'                  // Gray fallback
                    ],
                    'fill-opacity': 0.7
                }
            });
            
            // Add outline layer for clarity
            map.addLayer({
                id: 'subdivision-lots-outline',
                type: 'line',
                source: 'subdivision-results',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 1.5,
                    'line-opacity': 0.8
                }
            });
            
            // Fit map to show all features with nice padding
            const bounds = new mapboxgl.LngLatBounds();
            allFeatures.forEach(feature => {
                if (feature.geometry?.coordinates) {
                    const coords = feature.geometry.coordinates[0];
                    coords.forEach(coord => {
                        bounds.extend(coord);
                    });
                }
            });
            
            map.fitBounds(bounds, { 
                padding: 100,
                duration: 1000  // Smooth animation
            });
            
            console.log('[RENDER] Rendering complete!');
            
            // === LOAD OPTIMIZATION RESULT FOR CHATBOT ===
            loadOptimizationResultForChatbot(optimizationData);
        }

        // Load optimization result into chatbot memory
        async function loadOptimizationResultForChatbot(data) {
            try {
                // Store globally for chatbot access
                currentOptimizationResult = {
                    lots: [],
                    amenities: {
                        parks: [],
                        lakes: [],
                        parking: []
                    },
                    statistics: {}
                };

                // Extract lots and amenities from stages (optimized - no logging)
                data.stages.forEach(stage => {
                    if (stage.geometry && stage.geometry.features) {
                        stage.geometry.features.forEach(feature => {
                            const props = feature.properties || {};
                            const type = props.type || '';

                            if (type === 'lot') {
                                currentOptimizationResult.lots.push({
                                    zone: props.zone,
                                    area: feature.geometry.coordinates ? 
                                          calculatePolygonArea(feature.geometry.coordinates[0]) : 0
                                });
                            } else if (type === 'park') {
                                currentOptimizationResult.amenities.parks.push(feature);
                            } else if (type === 'water') {
                                currentOptimizationResult.amenities.lakes.push(feature);
                            } else if (type === 'parking') {
                                currentOptimizationResult.amenities.parking.push(feature);
                            }
                        });
                    }
                });

                // Store statistics
                currentOptimizationResult.statistics = data.statistics || {};

                // Send welcome message with stats (only if chatbot is open)
                if (chatbotOpen) {
                    setTimeout(() => {
                        addMessageToChat(
                            `‚úÖ **K·∫øt qu·∫£ t·ªëi ∆∞u ƒë√£ s·∫µn s√†ng!**\n\n` +
                            `üìä **T·ªïng quan:**\n` +
                            `‚Ä¢ ${currentOptimizationResult.lots.length} l√¥ ƒë·∫•t\n` +
                            `‚Ä¢ ${currentOptimizationResult.amenities.parks.length} khu c√¢y xanh\n` +
                            `‚Ä¢ ${currentOptimizationResult.amenities.lakes.length} h·ªì n∆∞·ªõc\n` +
                            `‚Ä¢ ${currentOptimizationResult.amenities.parking.length} b√£i ƒë·ªó xe\n\n` +
                            `üí¨ H√£y h·ªèi t√¥i v·ªÅ k·∫øt qu·∫£ n√†y!`
                        );
                    }, 1000);
                }

            } catch (err) {
                // Silent fail - don't block rendering
            }
        }

        // Helper: Calculate polygon area from coordinates
        function calculatePolygonArea(coords) {
            if (!coords || coords.length < 3) return 0;
            let area = 0;
            for (let i = 0; i < coords.length - 1; i++) {
                const [x1, y1] = coords[i];
                const [x2, y2] = coords[i + 1];
                area += x1 * y2 - x2 * y1;
            }
            return Math.abs(area / 2);
        }
    </script>
</body>
</html>